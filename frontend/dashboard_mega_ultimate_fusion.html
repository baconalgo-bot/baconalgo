    <!-- Configuration API -->
    <script src="config.js"></script>
    
    <script>
        // ==========================================
        // ü•ì BACONALGO - MEGA ULTIMATE FUSION
        // API Integration avec Scans R√©els
        // ==========================================

        const API_URL = CONFIG.API_URL;
        
        console.log('ü•ì Dashboard loaded!');
        console.log('üì° API URL:', API_URL);

        // ==========================================
        // √âtat Global
        // ==========================================
        let autoRefreshEnabled = false;
        let autoRefreshInterval = null;
        let scanData = [];
        let isScanning = false;

        // ==========================================
        // IBKR Functions
        // ==========================================
        async function connectIBKR() {
            const status = document.getElementById('ibkr-status');
            
            try {
                const result = await apiRequest('/api/ibkr/connect', { method: 'POST' });
                
                if (result.success) {
                    status.innerHTML = '<span>üü¢ IB Connected</span><span class="status-dot green"></span>';
                    status.className = 'ibkr-status connected';
                    alert('‚úÖ Connected to Interactive Brokers!');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('IBKR Connect Error:', error);
                alert('‚ö†Ô∏è Cannot connect to IBKR. Check if API is running.');
            }
        }

        async function disconnectIBKR() {
            const status = document.getElementById('ibkr-status');
            
            try {
                const result = await apiRequest('/api/ibkr/disconnect', { method: 'POST' });
                
                status.innerHTML = '<span>üî¥ IB Disconnected</span><span class="status-dot red"></span>';
                status.className = 'ibkr-status';
                alert('üõë Disconnected from Interactive Brokers!');
            } catch (error) {
                console.error('IBKR Disconnect Error:', error);
            }
        }

        function toggleAutoTrading() {
            const toggle = document.getElementById('auto-trading-toggle');
            toggle.classList.toggle('active');
            const isActive = toggle.classList.contains('active');
            
            if (isActive) {
                alert('‚úÖ Auto-Trading ENABLED!\n\nThe station will now execute trades automatically based on signals.');
            } else {
                alert('üõë Auto-Trading DISABLED!\n\nYou will receive signals but no automatic execution.');
            }
        }

        // ==========================================
        // Risk Management
        // ==========================================
        function changeRisk(type, amount) {
            const input = document.getElementById(type + '-value');
            let value = parseInt(input.value);
            value = Math.max(0, value + amount);
            input.value = value;
            console.log(`üí∞ Risk updated for ${type}: $${value}`);
        }

        // ==========================================
        // Scanner Functions - REAL API CALLS
        // ==========================================
        async function startScan() {
            if (isScanning) {
                alert('‚è≥ Scan already in progress...');
                return;
            }

            isScanning = true;
            console.log('üöÄ Starting REAL scan...');
            
            // Update UI
            document.getElementById('signal-count').textContent = '‚è≥ Scanning markets...';
            
            try {
                // Get selected markets
                const markets = getSelectedMarkets();
                
                // Get filter settings
                const filters = {
                    minScore: parseInt(document.getElementById('min-score-slider').value),
                    minWhaleScore: parseInt(document.getElementById('whale-score-slider').value),
                    markets: markets
                };
                
                console.log('üîç Scan parameters:', filters);
                
                // Call API
                const result = await apiRequest('/api/scanner/scan', {
                    method: 'POST',
                    body: JSON.stringify(filters)
                });
                
                if (result.success) {
                    scanData = result.data.signals || [];
                    console.log(`‚úÖ Scan complete! Found ${scanData.length} signals`);
                    
                    // Update UI with results
                    displayScanResults(scanData);
                    updateStats(scanData);
                    
                    alert(`‚úÖ Scan Complete!\n\nFound ${scanData.length} signals`);
                } else {
                    throw new Error(result.error);
                }
                
            } catch (error) {
                console.error('‚ùå Scan error:', error);
                alert(`‚ö†Ô∏è Scan Failed!\n\nError: ${error.message}\n\nMake sure API is running at:\n${API_URL}`);
                
                // Show demo data as fallback
                loadDemoData();
            } finally {
                isScanning = false;
            }
        }

        function getSelectedMarkets() {
            const markets = [];
            
            if (document.getElementById('sp500').checked) markets.push('sp500');
            if (document.getElementById('nasdaq100').checked) markets.push('nasdaq100');
            if (document.getElementById('dow30').checked) markets.push('dow30');
            if (document.getElementById('tsx60').checked) markets.push('tsx60');
            if (document.getElementById('crypto').checked) markets.push('crypto');
            if (document.getElementById('futures').checked) markets.push('futures');
            
            return markets;
        }

        // ==========================================
        // Display Functions
        // ==========================================
        function displayScanResults(signals) {
            const container = document.querySelector('.signals-grid');
            
            if (!signals || signals.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 60px; color: #8b949e;">
                        <div style="font-size: 3em; margin-bottom: 20px;">üîç</div>
                        <h3>No signals found matching your criteria</h3>
                        <p style="margin-top: 10px;">Try adjusting your filters or scan different markets.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = signals.map((signal, index) => createSignalCard(signal, index + 1)).join('');
            
            // Update signal count
            document.getElementById('signal-count').textContent = `‚úÖ Found ${signals.length} signals!`;
        }

        function createSignalCard(signal, rank) {
            const gradeColor = signal.score >= 90 ? 'legendary' : signal.score >= 80 ? 'epic' : 'rare';
            const gradeLabel = signal.score >= 90 ? 'LEGENDARY' : signal.score >= 80 ? 'EPIC' : 'RARE';
            const direction = signal.direction || 'LONG';
            const directionColor = direction === 'LONG' ? 'green' : 'red';
            
            return `
                <div class="signal-card">
                    <div class="grade-badge ${gradeColor}">Grade: ${gradeLabel}</div>
                    
                    <div class="signal-header">
                        <div class="signal-title">
                            <span class="signal-rank">#${rank}</span>
                            <div>
                                <div class="signal-symbol">${signal.symbol || 'N/A'}</div>
                                <div class="signal-timeframe">[${signal.timeframe || '1d'}]</div>
                            </div>
                        </div>
                        <div class="signal-type-tag">${signal.type ? 'üìä ' + signal.type.toUpperCase() : 'üìä SWING'}</div>
                    </div>

                    <div class="score-display">
                        <div class="diamonds">
                            ${signal.score >= 90 ? 'üíéüíéüíé' : signal.score >= 80 ? 'üíéüíé' : 'üíé'}
                        </div>
                        <span class="score-text">${signal.score || 0}/100</span>
                        <div class="score-bar">
                            <div class="score-fill" style="width: ${signal.score || 0}%;"></div>
                        </div>
                    </div>

                    <div class="main-metrics">
                        <div class="metric-box">
                            <div class="metric-icon">üî•</div>
                            <div class="metric-label">Entry</div>
                            <div class="metric-value ${directionColor}">$${signal.entry ? signal.entry.toFixed(2) : 'N/A'}</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-icon">üéØ</div>
                            <div class="metric-label">Target</div>
                            <div class="metric-value green">$${signal.target ? signal.target.toFixed(2) : 'N/A'}</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-icon">üõ°Ô∏è</div>
                            <div class="metric-label">Stop Loss</div>
                            <div class="metric-value red">$${signal.stopLoss ? signal.stopLoss.toFixed(2) : 'N/A'}</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-icon">üìà</div>
                            <div class="metric-label">R:R</div>
                            <div class="metric-value blue">${signal.rr ? signal.rr.toFixed(2) : '0.00'}:1</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-icon">üèÜ</div>
                            <div class="metric-label">Win %</div>
                            <div class="metric-value green">${signal.winRate || 0}%</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-icon">üî•</div>
                            <div class="metric-label">Confluence</div>
                            <div class="metric-value orange">${signal.confluence || 0}</div>
                        </div>
                    </div>

                    <div class="signal-badges">
                        <span class="badge ${direction === 'LONG' ? 'bullish' : 'bearish'}">
                            ${direction === 'LONG' ? 'üìà BULLISH' : 'üìâ BEARISH'}
                        </span>
                        ${signal.whaleScore > 70 ? '<span class="badge bullish">üêã WHALE ACTIVITY</span>' : ''}
                        ${signal.hasVolatility ? '<span class="badge bearish">‚ö° HIGH VOLATILITY</span>' : ''}
                    </div>

                    <div class="action-buttons">
                        <button class="btn-card btn-orange" onclick="executeSignal('${signal.symbol}', '${direction}')">
                            üöÄ Execute ${direction}
                        </button>
                        <button class="btn-card btn-dark" onclick="viewDetails('${signal.symbol}')">
                            üìä View Details
                        </button>
                    </div>
                </div>
            `;
        }

        function updateStats(signals) {
            const total = signals.length;
            const legendary = signals.filter(s => s.score >= 90).length;
            const avgScore = total > 0 ? Math.round(signals.reduce((sum, s) => sum + s.score, 0) / total) : 0;
            const whaleSignals = signals.filter(s => s.whaleScore > 70).length;
            
            // Update stat cards
            document.querySelectorAll('.stat-card')[0].querySelector('.stat-value').textContent = total;
            document.querySelectorAll('.stat-card')[1].querySelector('.stat-value').textContent = legendary;
            document.querySelectorAll('.stat-card')[2].querySelector('.stat-value').textContent = avgScore;
            document.querySelectorAll('.stat-card')[3].querySelector('.stat-value').textContent = whaleSignals;
        }

        // ==========================================
        // Trade Execution
        // ==========================================
        async function executeSignal(symbol, direction) {
            if (!confirm(`üöÄ Execute ${direction} trade on ${symbol}?\n\nThis will send the order to IBKR.`)) {
                return;
            }
            
            try {
                const result = await apiRequest('/api/trade/execute', {
                    method: 'POST',
                    body: JSON.stringify({
                        symbol: symbol,
                        direction: direction,
                        source: 'dashboard'
                    })
                });
                
                if (result.success) {
                    alert(`‚úÖ Trade Executed!\n\nSymbol: ${symbol}\nDirection: ${direction}\nOrder ID: ${result.data.orderId || 'N/A'}`);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('Trade execution error:', error);
                alert(`‚ö†Ô∏è Trade Failed!\n\nError: ${error.message}`);
            }
        }

        function viewDetails(symbol) {
            alert(`üìä Detailed Analysis: ${symbol}\n\nOpening TradingView chart...`);
            window.open(`https://www.tradingview.com/chart/?symbol=${symbol}`, '_blank');
        }

        // ==========================================
        // Auto Refresh
        // ==========================================
        function toggleAutoRefresh() {
            const btn = document.getElementById('auto-refresh-btn');
            autoRefreshEnabled = !autoRefreshEnabled;
            
            if (autoRefreshEnabled) {
                btn.textContent = 'üîÑ Auto-Refresh: ON';
                btn.style.background = 'linear-gradient(135deg, #3fb950 0%, #2ea043 100%)';
                
                // Start auto-refresh
                autoRefreshInterval = setInterval(() => {
                    console.log('üîÑ Auto-refreshing scan...');
                    startScan();
                }, CONFIG.REFRESH_INTERVAL * 1000);
                
                alert(`‚úÖ Auto-Refresh ENABLED!\n\nScanner will refresh every ${CONFIG.REFRESH_INTERVAL} seconds.`);
            } else {
                btn.textContent = 'üîÑ Auto-Refresh: OFF';
                btn.style.background = '#30363d';
                
                // Stop auto-refresh
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                
                alert('üõë Auto-Refresh DISABLED!');
            }
        }

        // ==========================================
        // Demo Data (Fallback)
        // ==========================================
        function loadDemoData() {
            console.log('üì¶ Loading demo data...');
            
            const demoSignals = [
                {
                    symbol: 'TSLA',
                    score: 96,
                    entry: 462.13,
                    target: 520.00,
                    stopLoss: 440.00,
                    rr: 2.62,
                    winRate: 94,
                    confluence: 387,
                    direction: 'LONG',
                    type: 'day',
                    timeframe: '1h',
                    whaleScore: 85
                },
                {
                    symbol: 'NVDA',
                    score: 94,
                    entry: 878.50,
                    target: 950.00,
                    stopLoss: 850.00,
                    rr: 2.51,
                    winRate: 92,
                    confluence: 365,
                    direction: 'LONG',
                    type: 'swing',
                    timeframe: '1d',
                    whaleScore: 78
                },
                {
                    symbol: 'SPY',
                    score: 88,
                    entry: 607.34,
                    target: 625.00,
                    stopLoss: 600.00,
                    rr: 2.40,
                    winRate: 87,
                    confluence: 298,
                    direction: 'LONG',
                    type: 'day',
                    timeframe: '30m',
                    whaleScore: 45
                }
            ];
            
            displayScanResults(demoSignals);
            updateStats(demoSignals);
            
            alert('‚ö†Ô∏è Showing DEMO data\n\nConnect to API for real-time scans.');
        }

        // ==========================================
        // Slider Updates
        // ==========================================
        document.getElementById('min-score-slider').oninput = function() {
            document.getElementById('min-score-value').textContent = this.value;
        };

        document.getElementById('whale-score-slider').oninput = function() {
            document.getElementById('whale-score-value').textContent = this.value;
        };

        // ==========================================
        // Event Listeners
        // ==========================================
        document.getElementById('auto-refresh-btn').addEventListener('click', toggleAutoRefresh);

        // ==========================================
        // Initialize
        // ==========================================
        window.addEventListener('DOMContentLoaded', () => {
            console.log('ü•ì Bacon Station MEGA ULTIMATE FUSION Initialized!');
            console.log('üì° Connected to API:', API_URL);
            
            // Load demo data on startup
            loadDemoData();
            
            // Test API connection
            testAPIConnection().then(isOnline => {
                if (isOnline) {
                    console.log('‚úÖ API is online! Ready for real scans.');
                } else {
                    console.warn('‚ö†Ô∏è API is offline. Using demo data.');
                }
            });
        });
    </script>
</body>
</html>
